<h1 id="example-mobile-agent-configuration-(physical-devices)">Example Mobile Agent Configuration (physical devices)</h1>
<p>(Pictures coming soon)</p>
<p>This is documentation for how the mobile agents are set up and configured (hardware and software) for the <a href="https://www.webpagetest.org/">public WebPageTest instance</a>. Properly configured the agents can run for months at a time with no human intervention and for the rare cases where intervention is needed, it can be managed remotely.</p>
<p>The hardware described is the hardware in use by the public instance but exact pieces can be swapped out as available (i.e. the exact model switch, cpu heatsinks, etc are probably not critical).</p>
<h1 id="recommended-hardware">Recommended Hardware</h1>
<h2 id="phones">Phones</h2>
<h3 id="android">Android</h3>
<ul>
<li>Devices need to be rootable (watch out for specific models of Samsung devices - some are rootable, some are not)</li>
<li>Preferably running android 4.4 through 6 to support reverse-tethering  which allows for self-contained networking and traffic-shaping directly on the Raspberry pi.  The configuration gets substantially more involved for devices that can not be reverse-tethered (still possible and reliable, just requires a FreeBSD bridge upstream of the wifi access point to do traffic-shaping).  Dev work is ongoing on fixing the support for reverse-tethering for Android 7+ which will significantly improve the situation for more modern devices.</li>
<li>Motorola and Google (Nexus or Pixel) devices are recommended as unlocking the bootloader on them is officially supported. The <a href="https://www.amazon.com/gp/product/B01DZJFSZ4/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Moto G4</a> in particular is highly recommended and is the main test device on WebPageTest.</li>
</ul>
<h3 id="ios">iOS</h3>
<ul>
<li>The iOS agent does not yet support reverse-tethering (design is done and development is underway so hopefully soon it will be available). Any iOS devices need to be run over WiFi with <a href="https://github.com/WPO-Foundation/webpagetest/blob/master/docs/Private%20Instances/MobileAgentRaspberryPi.md#traffic-shaping">remote traffic-shaping</a>.</li>
<li>All recent iOS devices should work as test agents as long as they are running iOS 9.3 or later.</li>
</ul>
<h2 id="support-hardware">Support Hardware</h2>
<ul>
<li><a href="https://www.amazon.com/gp/product/B01CD5VC92/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Raspberry Pi 3 Model B</a> with <a href="https://www.amazon.com/gp/product/B01GE7Q060/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">heatsink cooling kit</a> - One per phone</li>
<li><a href="https://www.amazon.com/gp/product/B06XWN9Q99/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Samsung Evo Select 32GB micro SD Card</a> - One per Raspberry Pi</li>
<li><a href="https://www.amazon.com/gp/product/B01MDLUSE7/ref=oh_aui_detailpage_o00_s01?ie=UTF8&amp;psc=1">Micro USB PoE Splitter</a> - One per Raspberry Pi</li>
<li><a href="https://www.amazon.com/gp/product/B00LW9A328/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">8-port</a> or <a href="https://www.amazon.com/NETGEAR-ProSAFE-GS752TP-Gigabit-GS752TP-100NAS/dp/B00BGTPQO4/">48-port</a> managed PoE switch</li>
<li><a href="https://www.amazon.com/gp/product/B01FRQJ1Y2/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">RJ-45 SFP Transceiver</a> (optional) - One per switch. Allows use of SFP port on switch for uplink connection saving PoE ports for test devices</li>
<li><a href="https://www.amazon.com/gp/product/B01BGV2ZC2/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Slim Ethernet patch cable</a> - One per Raspberry Pi, length as appropriate to reach from switch to test device</li>
<li><a href="https://www.amazon.com/gp/product/B00UFG5GVM/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Micro USB cable</a> - One per phone (Or just use cable that came with phone)</li>
<li><a href="https://www.amazon.com/gp/product/B06XG5CP6D/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">USB 3.0 Hub</a> - As needed for large tablets (full-size iPads). Use the power adapter from the tablet to power the hub.</li>
<li><a href="https://www.amazon.com/gp/product/B008ALA2RC/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">AirPort Express Base Station</a></li>
<li><a href="https://www.tinkercad.com/things/3SfNUY30eFd-shelf-large-vertical-phone-stand-85mm-max-width">3-D Printed</a> or <a href="https://www.amazon.com/dp/B07438NMTX/">store-bought</a> Phone Stand - One per Phone</li>
</ul>
<h1 id="hardware-configuration">Hardware Configuration</h1>
<ul>
<li>Configure the switch and assign it a static IP address for management</li>
<li>Install <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Stretch Lite</a> to the micro SD Card and install it in the Raspberry Pi</li>
<li>Connect the Raspberry Pi to a keyboard and monitor and go through the initial OS configuration
<ul>
<li>Enable SSH</li>
<li>Assign it a static IP address</li>
</ul>
</li>
<li>Attach the Raspberry Pi to the back of the phone stand with zip ties - optionally with <a href="https://www.amazon.com/gp/product/B00PX0R8W0/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">3M heavy-duty fasteners</a> behind the Pi for spacing, particularly if the phone stand is metal.</li>
<li>Attach the PoE splitter
<ul>
<li>Attach the micro USB out to the Pi power connector</li>
<li>Attach the Ethernet out to the Pi Ethernet port (keep track of which port each device is connected to)</li>
<li>Mount the splitter to the phone stand (under where the phone sits) either with double-sided tape or friction (for the 3D-printed stands the PoE splitter fits snugly in the middle of the supports)</li>
</ul>
</li>
<li>Mount the phone onto the stand</li>
<li>Route the Micro USB cable from the Pi to the Phone (through the stand)</li>
<li>Attach the slim ethernet cable from the PoE splitter to the PoE switch</li>
</ul>
<p>At this point you should have the phone and Pi as a stand-alone package connected by a single slim ethernet cable to the PoE switch</p>
<h1 id="device-setup">Device Setup</h1>
<h3 id="android-1">Android</h3>
<ul>
<li>Unlock the bootloader (this will reset the device so don't bother doing any software configuration until after it is unlocked)</li>
<li>Connect to the WiFi access point
<ul>
<li>If using remote shaping (not reverse-tethered for testing) assign the device a static IP address that matches one of the pipe configurations on the remote BSD bridge.</li>
</ul>
</li>
<li>Enable Developer Mode</li>
<li>In developer options:
<ul>
<li>Enable USB debugging</li>
<li>Disable checking of apps installed over USB</li>
<li>Configure the display to stay awake when connected</li>
</ul>
</li>
<li>In Security settings:
<ul>
<li>Make sure there is no pin or pattern configured</li>
<li>Set the lock screen to &quot;None&quot;</li>
</ul>
</li>
<li>In account settings, disable sync for all of the services</li>
<li>Go to the play store and install the browsers that will be used for testing</li>
<li>Root The Phone</li>
<li>Go into SuperSU and configure:
<ul>
<li>Default access to grant</li>
<li>Disable logging</li>
<li>Disable notification</li>
</ul>
</li>
</ul>
<h3 id="ios-1">iOS</h3>
<ul>
<li>Configurion iOS test agents requires building the <a href="https://github.com/WPO-Foundation/iWptBrowser">iWptBrowser app</a> and installing it onto the phones.  There is a detailed walkthrough for setting up the phones so they automatically boot into the agent software <a href="https://github.com/WPO-Foundation/iWptBrowser/blob/master/docs/walkthrough.md">here</a>.</li>
</ul>
<h1 id="raspberry-pi-configuration">Raspberry Pi Configuration</h1>
<p>TODO: This can be automated and <a href="https://github.com/WPO-Foundation/wptagent-install">published as an install script for wptagent</a>.</p>
<ul>
<li>work out of the user's home directory</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~</code></pre>
<ul>
<li>Add the current user to sudoers</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token environment constant">$USER</span> ALL=(ALL:ALL) NOPASSWD:ALL"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token assign-left variable">EDITOR</span><span class="token operator">=</span><span class="token string">'tee -a'</span> visudo</code></pre>
<ul>
<li>Update the base OS distribution</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> -y dist-upgrade</code></pre>
<ul>
<li>Install the required packages:</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y python2.7 python-pip imagemagick <span class="token function">traceroute</span> <span class="token function">screen</span> watchdog <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> pip <span class="token function">install</span> dnspython monotonic pillow psutil requests ujson tornado</code></pre>
<ul>
<li>Download and install the 32-bit armel build of ffmpeg (even though the pi has hardware float and 64-bit, those builds do not work correctly on it and neither does the one from apt)</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-armel-32bit-static.tar.xz <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token function">tar</span> -xf ffmpeg-release-armel-32bit-static.tar.xz --wildcards --strip<span class="token operator">=</span><span class="token number">1</span> *ffmpeg <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token function">sudo</span> <span class="token function">cp</span> ffmpeg /usr/bin <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token function">rm</span> ffmpeg*</code></pre>
<ul>
<li>Clone the wptagent code</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/WPO-Foundation/wptagent.git</code></pre>
<ul>
<li>Configure watchdog</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"test-binary = <span class="token environment constant">$PWD</span>/wptagent/alive.sh"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/watchdog.conf <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token builtin class-name">echo</span> <span class="token string">"watchdog-device = /dev/watchdog"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/watchdog.conf<br><span class="token builtin class-name">echo</span> <span class="token string">"watchdog-timeout = 15"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/watchdog.conf</code></pre>
<ul>
<li>Configure the startup script to launch the agent</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'#!/bin/sh'</span> <span class="token operator">></span> ~/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token builtin class-name">echo</span> <span class="token string">"PATH=<span class="token environment constant">$PWD</span>/bin:<span class="token environment constant">$PWD</span>/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"</span> <span class="token operator">>></span> ~/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token builtin class-name">echo</span> <span class="token string">'screen -dmS agent ~/agent.sh'</span> <span class="token operator">>></span> ~/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token builtin class-name">echo</span> <span class="token string">'sudo service watchdog restart'</span> <span class="token operator">>></span> ~/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span><br><span class="token function">chmod</span> +x ~/startup.sh</code></pre>
<ul>
<li>Configure the agent script for installing updates and running the agent</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">nano</span> ~/agent.sh</code></pre>
<p>Paste=in the agent script (change the location, key and command-line options as necessary):</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><br><span class="token builtin class-name">export</span> <span class="token assign-left variable">DEBIAN_FRONTEND</span><span class="token operator">=</span>noninteractive<br><span class="token builtin class-name">cd</span> ~/wptagent<br><span class="token builtin class-name">echo</span> <span class="token string">"Waiting for 30 second startup delay"</span><br><span class="token function">sleep</span> <span class="token number">30</span><br><span class="token builtin class-name">echo</span> <span class="token string">"Waiting for apt to become available"</span><br><span class="token keyword">while</span> <span class="token function">fuser</span> /var/lib/dpkg/lock <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><br>    <span class="token function">sleep</span> <span class="token number">1</span><br><span class="token keyword">done</span><br><span class="token keyword">while</span> <span class="token builtin class-name">:</span><br><span class="token keyword">do</span><br>    <span class="token builtin class-name">echo</span> <span class="token string">"Updating OS"</span><br>    <span class="token keyword">until</span> <span class="token function">sudo</span> <span class="token function">timeout</span> 20m <span class="token function">apt-get</span> update<br>    <span class="token keyword">do</span><br>        <span class="token function">sleep</span> <span class="token number">1</span><br>    <span class="token keyword">done</span><br>    <span class="token keyword">until</span> <span class="token function">sudo</span> <span class="token assign-left variable">DEBIAN_FRONTEND</span><span class="token operator">=</span>noninteractive <span class="token function">apt-get</span> -yq -o Dpkg::Options::<span class="token operator">=</span><span class="token string">"--force-confdef"</span> -o Dpkg::Options::<span class="token operator">=</span><span class="token string">"--force-confold"</span> dist-upgrade<br>    <span class="token keyword">do</span><br>        <span class="token function">sleep</span> <span class="token number">1</span><br>    <span class="token keyword">done</span><br>    <span class="token function">sudo</span> <span class="token function">apt-get</span> -y autoremove<br>    <span class="token function">sudo</span> <span class="token function">npm</span> i -g lighthouse<br>    <span class="token function">sudo</span> fstrim -v /<br>    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">24</span><span class="token variable">`</span></span><br>    <span class="token keyword">do</span><br>        <span class="token function">timeout</span> 10m <span class="token function">git</span> pull origin master<br>        python wptagent.py --name <span class="token operator">&lt;</span>device name<span class="token operator">></span> --location <span class="token operator">&lt;</span>location<span class="token operator">></span> --key xxx -vvvv --server <span class="token string">"http://&lt;server>/work/"</span> --android --vpntether eth0,192.168.0.1 --shaper netem,eth0 --exit <span class="token number">60</span> --alive /tmp/wptagent<br>        <span class="token builtin class-name">echo</span> <span class="token string">"Exited, restarting"</span><br>        <span class="token function">sleep</span> <span class="token number">1</span><br>    <span class="token keyword">done</span><br><span class="token keyword">done</span><br></code></pre>
<ul>
<li>Make the agent script executable</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">chmod</span> +x ~/agent.sh</code></pre>
<ul>
<li>Create a crontab entry to start the startup script at boot</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token punctuation">(</span> <span class="token function">crontab</span> -l <span class="token operator">|</span> <span class="token function">grep</span> -v -F <span class="token string">"<span class="token variable">$@</span>reboot <span class="token environment constant">$PWD</span>/startup.sh"</span> <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$@</span>reboot <span class="token environment constant">$PWD</span>/startup.sh"</span> <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">crontab</span> -</code></pre>
<ul>
<li>Disable WiFi on the Pi</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"dtoverlay=pi3-disable-wifi"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /boot/config.txt</code></pre>
<ul>
<li>Overclock the SD card</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"dtparam=sd_overclock=100"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /boot/config.txt</code></pre>
<ul>
<li>Enable the hardware watchdog</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"dtparam=watchdog=on"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /boot/config.txt</code></pre>
<h1 id="operational-notes">Operational Notes</h1>
<p>Optimally the agent will automatically update the agent software hourly and daily it will update the OS, lighthouse and trim the SD card.</p>
<p>If something fails with the agent itself or the raspberry Pi locks up the watchdog will reboot the Pi and it should continue operating seamlessly.  The /getTesters.php page on the WebPageTest server will show the agent uptime.  If there is an agent with a consistently lower uptime than the others it may be worth looking at the hardware and software config to understand why it keeps rebooting.</p>
<p>You can monitor the agent activity directly by connecting ssh to the pi and running &quot;screen -r&quot; to connect to the screen session running the agent (make sure to disconnect the screen session, not kill the agent process).</p>
<p>If the phone goes offline but the pi is still responding you can ssh into the pi and &quot;adb reboot&quot; the phone.  When the phone finishes rebooting it should automatically start testing again.</p>
<p>If the pi goes offline and isn't responding to ssh (and wasn't automatically recovered by the watchdog) you can connect to the management interface on the PoE switch, going into the PoE port settings, disabling the port the pi is connected to and then re-enabling it (that cuts power to the Pi and restores it).</p>
